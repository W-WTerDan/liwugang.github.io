<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>LEB128相关知识 - Liwugang's Blog</title>

	<link rel="shortcut icon" href="/styles/images/favicon.jpg">
	<link rel="icon" href="/styles/images/favicon.jpg">

	<link rel="stylesheet" href="/styles/css/index.css">
	<link rel="stylesheet" href="/styles/css/fontawesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="/styles/css/syntax.css">
	<link rel="canonical" href="/2016/01/07/LEB128/">
	<link rel="alternate" type="application/rss+xml" title="Liwugang's Blog" href="/feed.xml">
	
	<meta name="keywords" content="LEB128相关知识, Liwugang's Blog, liwugang;个人博客;">
	<meta name="description" content="liwugang;个人博客;">

	<script src="/styles/js/jquery.min.js"></script>
	<!--[if lt IE 9]>
    	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  	<![endif]-->
  	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?1d2fe4c4c213d17757e0b1a94713ead0";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>

  <body class="index">

    <header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">
        <!--<img src="/styles/images/logo.jpg">-->
      </a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">    
        <li>
          <a href="/">Home</a>
        </li>
        <li>
          <a href="/categories/">Categories</a>
        </li>
        <li>
          <a href="/tag">Tags</a>
        </li>
        <li>
          <a rel="nofollow" target="_blank" href="https://github.com/liwugang/" >Github</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
            <a><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></a>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">关于<b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a rel="nofollow" target="_blank" href="https://liwugang.github.io/">关于作者</a></li>
            <li><a href="/feed.xml">RSS订阅</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>
    <div class="docs-header" id="content">
  <div class="container">
  	
  		<!--
		    <h1>LEB128相关知识</h1>
		    <p>Post on Jan 07, 2016 by <a href="/about">Li Wugang</a></p>
		-->
		    <h1></h1>
    
  </div>
</div>
    
      
<div class="banner">
  <div class="container">
  	
    	<a href="/categories/#Android-ref">Android</a>	/
    	<a href="/tag/#Android-ref">Android</a>
    
  </div>
</div>

    

    <div class="container docs-container">
  <div class="row">
    <div class="col-md-3">
      <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
  <h1>目录</h1>
  <ul class="nav sidenav">
  </ul>
  <div style="height: 200px;width: 200px;">
  </div>
</div>

 
      </div>
    </div>
    <div class="col-md-9" role="main">
      <div class="panel docs-content">
        <div class="wrapper">
            <header class="post-header">
              <h1 class="post-title">LEB128相关知识</h1>
              <!--
                <p class="post-meta">Jan 7, 2016</p>
              -->
              <div class="meta">Posted on <span class="postdate">Jan 07, 2016</span> By <a target="_blank" href="http://localhost:4000">Li Wugang</a></div>
              <br />
            </header>
            <article class="post-content">
              <ul id="markdown-toc">
  <li><a href="#介绍" id="markdown-toc-介绍">介绍</a>    <ul>
      <li><a href="#无符号整数" id="markdown-toc-无符号整数">无符号整数</a>        <ul>
          <li><a href="#编码代码为" id="markdown-toc-编码代码为">编码代码为：</a></li>
          <li><a href="#解码代码为" id="markdown-toc-解码代码为">解码代码为：</a></li>
        </ul>
      </li>
      <li><a href="#有符号数" id="markdown-toc-有符号数">有符号数</a>        <ul>
          <li><a href="#编码代码为-1" id="markdown-toc-编码代码为-1">编码代码为：</a></li>
          <li><a href="#编码代码为-2" id="markdown-toc-编码代码为-2">编码代码为：</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#总结" id="markdown-toc-总结">总结</a></li>
  <li><a href="#参考" id="markdown-toc-参考">参考</a></li>
</ul>

<h1 id="介绍">介绍</h1>
<p>LEB128(little endian base 128)是一种变长的整数压缩编码形式，它是出自于<a href="http://www.dwarfstd.org/">DWARF debug file format</a>。在Android的<a href="https://source.android.com/devices/tech/dalvik/dex-format.html">Dalvik Executable format</a>中使用该编码用于表示32位整数。由于32位整数占用固定的4个字节，可能大多数整数并不需要4个字节，最高几个字节可能为0（正数）或者为1（负数），该编码就是不保存最高位的这些字节。
原理
==================
LEB128的表现形式都是一样的，如下面表格所示，由于是little endian，因此是从低字节到高字节。每个字节中的最高bit是标识信息，1表示还有后续字节，0表示结束，后面7bits是有效数据。将多个字节的该7bits从低到高组合起来就是所表示的整数。
LEB128分成有符号数和无符号数两种分别进行处理，不过，只是在编码和解码过程有些不同。</p>

<table>
  <thead>
    <tr>
      <th>低地址</th>
      <th>+1</th>
      <th>+2</th>
      <th>+3</th>
      <th>+4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0 xxxxxxx</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>1 xxxxxxx</td>
      <td>0 xxxxxxx</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>1 xxxxxxx</td>
      <td>1 xxxxxxx</td>
      <td>0 xxxxxxx</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>1 xxxxxxx</td>
      <td>1 xxxxxxx</td>
      <td>1 xxxxxxx</td>
      <td>0 xxxxxxx</td>
      <td> </td>
    </tr>
    <tr>
      <td>1 xxxxxxx</td>
      <td>1 xxxxxxx</td>
      <td>1 xxxxxxx</td>
      <td>1 xxxxxxx</td>
      <td>0 xxxxxxx</td>
    </tr>
  </tbody>
</table>

<h2 id="无符号整数">无符号整数</h2>
<p>将无符号整数写成二进制形式，从低位到高位7个bits为一个整体组合成一个字节，在该字节最高位填入上述所说的标识信息。</p>

<p>下面以10000为例，编码过程：</p>

<table>
  <thead>
    <tr>
      <th>二进制形式为</th>
      <th>10 0111 0001 0000</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>以7bits为整体</td>
      <td>1001110 0010000</td>
    </tr>
    <tr>
      <td>添加标识组合成新的字节(从后往前，即低bits到高bits）</td>
      <td>01001110(0x4E)    10010000(0x90) (最高位标识设置为0，表示没有后续字节)</td>
    </tr>
    <tr>
      <td>LEB128 则为</td>
      <td>0x90 0x4F (小端存放)</td>
    </tr>
  </tbody>
</table>

<p>解码过程：</p>

<table>
  <thead>
    <tr>
      <th>LEB128</th>
      <th>0x90 0x4E</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>二进制形式</td>
      <td>10010000 01001110</td>
    </tr>
    <tr>
      <td>去掉标识信息</td>
      <td>0010000（低7bits) 1001110（高7bits）</td>
    </tr>
    <tr>
      <td>组合的结果为</td>
      <td>10011100010000 （10000）</td>
    </tr>
  </tbody>
</table>

<h3 id="编码代码为">编码代码为：</h3>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kt">void</span> <span class="nf">EncodeULEB128</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">leb128_buffer</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">leb128_buffer</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x7F</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span> <span class="c1">//每个字节标识信息都设为1</span>
			<span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">leb128_buffer</span><span class="p">[</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x7F</span><span class="p">;</span>  <span class="c1">//将最后一个字节的标识信息设为0</span>
	<span class="p">}</span>
</code></pre></div></div>
<h3 id="解码代码为">解码代码为：</h3>
<pre><code class="language-C++">	void DecodeULEB128(unsigned char *leb128_buffer, unsigned int *value)
	{
		int pos = 0;
		int offset = 0;
		while (buffer[pos] != 0) {
			*value |= ( (buffer[pos] &amp; 0x7F) &lt;&lt; offset ); //从低到高将 bits 合并到一起
			offset += 7;
			if (buffer[pos] &amp; 0x80 == 0)
				break;
			pos += 1; 
		}
	}
</code></pre>
<h2 id="有符号数">有符号数</h2>
<p>有符号数分成了正数和负数，在计算机的存储中都是以补码存储，正数和上述无符号数一样的处理，负数的处理会有些区别，以-10000为例说明，</p>

<p>编码过程：</p>

<table>
  <thead>
    <tr>
      <th>二进制补码</th>
      <th>11111111 11111111 11111100 00011000（可以看出最高两字节都是符号扩展的1）</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>以7bits为整体</td>
      <td>1111 1111111 1111111 1111000 0011000</td>
    </tr>
    <tr>
      <td>添加标识信息组合新的字节(从后往前，即低bits到高bits）</td>
      <td>01111000  10011000（此处结束条件不像上面那么明显，若前面和该7bits的最高位都为1时停止）</td>
    </tr>
    <tr>
      <td>LEB128则为</td>
      <td>0x98 0x78</td>
    </tr>
  </tbody>
</table>

<p>解码过程：</p>

<table>
  <thead>
    <tr>
      <th>LEB128</th>
      <th>0x98 0x78</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>二进制形式</td>
      <td>10011000 01111000</td>
    </tr>
    <tr>
      <td>去掉标识信息</td>
      <td>0011000 1111000  (若最后一个字节中7bits的最高位为1，则前面需要符号扩展都添加1）</td>
    </tr>
    <tr>
      <td>组合结果</td>
      <td>11111111 11111111 1111100 00011000 (-10000)</td>
    </tr>
  </tbody>
</table>

<h3 id="编码代码为-1">编码代码为：</h3>

<pre><code class="language-C++">	void EncodeLEB128(int value, unsigned char *buffer)
	{
		int pos = 0;
		int more = 1;
		while (more) {
			unsigned char byte = value &amp; 0x7F;
			value &gt;&gt;= 7;
			if ( ((value == 0) &amp;&amp; (byte &amp; 0x40) == 0) ||  //正数
				((value == -1) &amp;&amp; (byte &amp; 0x40) != 0) ) //负数
				more = 0;
			if (more != 0)
				byte != 0x80;
			buffer[pos++] = byte;
		}
	}
</code></pre>
<h3 id="编码代码为-2">编码代码为：</h3>

<pre><code class="language-C++">	void DecodeLEB128(unsigned char *buffer, int *value)
	{
		int pos = 0;
		int offset = 0;
		unsigned char byte = buffer[pos++];
		
		while (byte &gt;= 0x80) {
			*value |= (byte &amp; 0x7f) &lt;&lt; offset;
			offset += 7;
			byte = buffer[pos++];
		}
		if (byte &amp; 0x40)
			*value |= -(1 &lt;&lt; offset);
	}
</code></pre>

<h1 id="总结">总结</h1>
<p>LEB128的理解难点是在有符号数上，编码结束条件不像无符号数那么明显（value等于0），分两种情况：</p>
<ol>
  <li>若为正数，7bits中的最高位为0 并且 value == 0结束，value ==0 表示高字节没有数据，而7bits最高位为0用于表示是正数，用于解码；</li>
  <li>若为负数，7bits中的最高位为1 并且 value == -1结束， value == -1表示高字节都是符号扩展出来的1， 7bits最高位为1用于表示是负数，在解码时高位填充1。</li>
</ol>

<h1 id="参考">参考</h1>
<p><a href="https://en.wikipedia.org/wiki/LEB128">https://en.wikipedia.org/wiki/LEB128</a></p>

<p><a href="http://llvm.org/docs/doxygen/html/LEB128_8h_source.html">http://llvm.org/docs/doxygen/html/LEB128_8h_source.html</a></p>

            </article>
        </div>
      </div>
    </div>
  </div>
</div>

    
    <footer class="footer" role="contentinfo">
	<div class="container">
		<p class="copyright">Copyright &copy; 2014-2019 <a href="https://liwugang.github.io/"><code>Li Wugang</code></a>.</p>
		<p>Powered by <a href="http://jekyllrb.com">Jekyll</a>, themed from <a href="http://lesscss.cn/">Less</a>, refactored by <a href="https://github.com/luoyan35714/LessOrMore">Freud Kang</a></p>
	</div>
</footer>

<script src="/styles/js/jquery.min.js"></script>
<script src="/styles/js/bootstrap.min.js"></script>
<script src="/styles/js/holder.min.js"></script>
<script src="/styles/js/lessismore.js"></script>
<script src="/styles/js/application.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  </body>
</html>
